@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<Event>

@{
    ViewBag.Title = "Event | Index";
    // Add "Created By" field for admins only
    string[] fields = ViewBag.UserRole == "Admin"
        ? new[] { "Photo", "Event Name", "Start Date", "End Date", "Start Time", "End Time", "Location", "Description", "Status", "Created By" }
        : new[] { "Photo", "Event Name", "Start Date", "End Date", "Start Time", "End Time", "Location", "Description", "Status" };
}

@section head {
    <style>
          .event-image {
              width: 100px;
              height: 100px;
              object-fit: cover;
              border: 1px solid #ddd;
              border-radius: 8px;
          }

        /*   .role-indicator {
              margin-bottom: 20px;
              padding: 10px 15px;
              border-radius: 8px;
              font-weight: 500;
          }

          .role-admin {
              background-color: #d4edda;
              color: #155724;
              border: 1px solid #c3e6cb;
          }

          .role-member {
              background-color: #d1ecf1;
              color: #0c5460;
              border: 1px solid #bee5eb;
          }

          .created-by-column {
              font-style: italic;
              color: #6c757d;
          } */
    </style>
}

<!-- Role Indicator -->
@if (ViewBag.ShowingMyEvents == true)
{
    <div class="role-indicator role-member">
        <i class="fas fa-user"></i> <strong>Member View:</strong> Showing only events you created (@Model.TotalItemCount record(s))
    </div>
}
else if (ViewBag.UserRole == "Admin")
{
    <div class="role-indicator role-admin">
        <i class="fas fa-crown"></i> <strong>Admin View:</strong> Showing all events (@Model.TotalItemCount record(s))
    </div>
}

<p>
    <a href="@Url.Action("Event_Insert")" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add New Event
    </a>
</p>

<form>
    @Html.TextBox("name", "",
    new { type = "search", autofocus = "", data_trim = "", placeholder = "Search events...", @class = "form-control d-inline-block", style = "width: 300px;" })
    @Html.Hidden("sort")
    @Html.Hidden("dir")
    <button class="btn btn-outline-secondary ms-2">
        <i class="fas fa-search"></i> Search
    </button>
    @if (!string.IsNullOrEmpty(ViewBag.Name))
    {
        <a href="@Url.Action("Event_Index")" class="btn btn-outline-danger ms-2">
            <i class="fas fa-times"></i> Clear
        </a>
    }
</form>

<div class="table-responsive mt-3">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                @foreach (var f in fields)
                {
                    string d = "asc";
                    string c = "";

                    if (f == ViewBag.Sort)
                    {
                        d = ViewBag.Dir == "des" ? "asc" : "des";
                        c = ViewBag.Dir == "des" ? "desc" : "asc";
                    }

                    <th>
                        <a href="?name=@ViewBag.Name&sort=@f&dir=@d" class="text-white text-decoration-none @c">
                            @f
                            @if (f == ViewBag.Sort)
                            {
                                if (ViewBag.Dir == "des")
                                {
                                    <i class="fas fa-sort-down"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort-up"></i>
                                }
                            }
                        </a>
                    </th>
                }
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in Model)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(e.EventPhotoURL))
                        {
                            <img src="/events/@e.EventPhotoURL" class="event-image" alt="@e.EventTitle">
                        }
                        else
                        {
                            <div class="event-image d-flex align-items-center justify-content-center bg-light text-muted">
                                <i class="fas fa-image fa-2x"></i>
                            </div>
                        }
                    </td>
                    <td class="fw-semibold">@e.EventTitle</td>
                    <td>@e.EventStartDate.ToString("dd/MM/yyyy")</td>
                    <td>@e.EventEndDate.ToString("dd/MM/yyyy")</td>
                    <td>@e.EventStartTime.ToString(@"hh\:mm")</td>
                    <td> @e.EventEndTime.ToString(@"hh\:mm")</td>
                    <td>@e.EventLocation</td>
                    <td>
                        @if (e.EventDescription?.Length > 50)
                        {
                            <span title="@e.EventDescription">@e.EventDescription.Substring(0, 50)...</span>
                        }
                        else
                        {
                            @e.EventDescription
                        }
                    </td>
                    <td>
                        @{
                            string statusClass = e.EventStatus?.ToLower() switch
                            {
                                "upcoming" => "badge bg-success",
                                "ongoing" => "badge bg-warning text-dark",
                                "concluded" => "badge bg-secondary",
                                _ => "badge bg-secondary"
                            };
                        }
                        <span class="@statusClass">@e.EventStatus</span>
                    </td>

                    @* Show Created By column only for admins *@
                    @if (ViewBag.UserRole == "Admin")
                    {
                        <td class="created-by-column">
                            @(e.CreatedBy ?? "N/A")
                        </td>
                    }

                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" data-get="@Url.Action("Event_Details", "NGO_Event_", new { id = e.EventID })" title="View Details">
                                Details
                            </button>
                            <button class="btn btn-sm btn-danger" data-get="@Url.Action("Event_Update", new { id = e.EventID })" title="Edit">
                                Update
                            </button>
                            <button class="btn btn-sm btn-secondary" data-post="@Url.Action("Delete", new { id = e.EventID })"
                                    onclick="return confirm('Are you sure you want to delete this event?')" title="Delete">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* Pagination *@
@if (Model.PageCount > 1)
{
    <div class="d-flex justify-content-center mt-4">
        @{
            var options = PagedListRenderOptions.ClassicPlusFirstAndLast;
            options.LinkToFirstPageFormat = "First";
            options.LinkToLastPageFormat = "Last";
            options.LinkToPreviousPageFormat = "Previous";
            options.LinkToNextPageFormat = "Next";
            options.UlElementClasses = new[] { "pagination" };
            options.LiElementClasses = new[] { "page-item" };
            options.PageClasses = new[] { "page-link" };
        }
        @Html.PagedListPager(Model, page => Url.Action("Event_Index", new { name = ViewBag.Name, sort = ViewBag.Sort, dir = ViewBag.Dir, page }), options)
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-info text-center">
        <h4>No Events Found</h4>
        @if (ViewBag.ShowingMyEvents == true)
        {
            <p>You haven't created any events yet. <a href="@Url.Action("Event_Insert")" class="alert-link">Create your first event</a>!</p>
        }
        else if (!string.IsNullOrEmpty(ViewBag.Name))
        {
            <p>No events match your search criteria. <a href="@Url.Action("Event_Index")" class="alert-link">Show all events</a></p>
        }
        else
        {
            <p>There are currently no events in the system. <a href="@Url.Action("Event_Insert")" class="alert-link">Create the first event</a>!</p>
        }
    </div>
}